name: Backend CI

on: 
    push:
        paths:
            - backend/**
        branches:
            - main
    pull_request:
        paths:
            - backend/**
        branches:
            - main
    workflow_dispatch:

jobs: 
    code-validation:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: backend/
        steps:
            - name: Checkout COde
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

            - name: Setup Node
              uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
              with:
                node-version: 22.x
                cache: 'npm'

            - name: Install dependencies 
              run: npm install

            - name: Lint test
              run: npm run lint

            - name: Node test
              run: npm run test

            - name: Secret Scanning
              uses: trufflesecurity/trufflehog@0f58ae7c5036094a1e3e750d18772af92821b503
              with:
                extra_args: --results=verified,unknown

            - name: SonarQube Scan
              uses: SonarSource/sonarqube-scan-action@1a6d90ebcb0e6a6b1d87e37ba693fe453195ae25
              env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

            - name: SonarQube Quality Gate check
              id: sonarqube-quality-gate-check
              uses: sonarsource/sonarqube-quality-gate-action@cf038b0e0cdecfa9e56c198bbb7d21d751d62c3b
              with:
                pollingTimeoutSec: 600
              env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
